# 02-20-2026 13:00

## Session Focus

Fix the silent audio visualizer and rename app to Ditty.

## Problem

Core Audio Process Tap connected to Music.app without errors — tap creation, aggregate device, IO proc all returned `noErr`, callbacks fired at ~100Hz — but audio buffers contained all zeros (silence).

## Root Causes Found

### 1. Ad-hoc code signing invalidated TCC grants
The Makefile used `codesign --sign -` (ad-hoc). Every rebuild produced a different code signature, causing TCC to silently deny permission without re-prompting. Fixed by creating a stable `DittyDev` self-signed certificate.

### 2. Sub-devices in aggregate device
The aggregate device included the system output device as a sub-device (AudioCap pattern). Removed it — tap-only aggregate (SoundPusher pattern). Both approaches produce callbacks, but the tap-only approach is cleaner.

### 3. Format read from wrong source
Was reading `kAudioDevicePropertyStreamFormat` from the aggregate device. Changed to `kAudioTapPropertyFormat` from the tap ID.

### 4. TCC requires app bundle launch (the actual blocker)
Even with all the above fixes, running the binary directly (`./Ditty.app/Contents/MacOS/MusicController`) delivers zero buffers. TCC only grants System Audio Recording permission when the app is launched via `open Ditty.app` (through LaunchServices). This was the critical discovery — all previous debugging had been running the binary directly.

### 5. FFT normalization was wrong for tap signal levels
The tap delivers signal at ~-30dB RMS. The original normalization expected 10-60dB range, mapping everything to zero. Rewrote with adaptive normalization, log-frequency mapping, and high-frequency boost.

## Changes

- **Makefile**: `APP_NAME = Ditty`, codesign with `DittyDev` identity
- **Info.plist**: Bundle ID `com.shaun.Ditty`, name `Ditty`, updated descriptions
- **App.swift**: Renamed struct to `DittyApp`, updated menu strings
- **AudioAnalyzer.swift**: Major rewrite
  - Tap-only aggregate device (no sub-devices)
  - Format from `kAudioTapPropertyFormat` on tap ID
  - Log-frequency band mapping (perceptual, ~30Hz–20kHz)
  - Amplitude (sqrt of power) instead of raw power
  - Peak-per-band instead of average (more reactive)
  - Adaptive normalization against running peak
  - High-frequency energy boost (1x low end to 3.5x high end)
  - Instant attack, quick decay smoothing
- **entitlements.plist**: `com.apple.security.device.audio-input` (unchanged)
- **DittyDev certificate**: Self-signed code signing cert in login keychain

## Key Learnings

- macOS TCC for Screen & System Audio Recording silently delivers zero-filled buffers when denied — no error codes, no feedback
- TCC permission context differs between `open App.app` (LaunchServices) and running the binary directly — always launch via `open` or `make run`
- `tccutil reset AudioCapture` is NOT the right service — use `tccutil reset ScreenCapture` for Screen & System Audio Recording
- Ad-hoc codesigning (`--sign -`) produces different signatures per build, confusing TCC
- The tap-only aggregate device approach works; AudioTee's two-step approach (empty device + property set) fails with `AudioDeviceStart` error 1852797029

## Next

- Continue refining visualizer feel (responsiveness, dynamics)
- Polish UI
